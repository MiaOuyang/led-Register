# 1 STM32F103系列芯片的地址映射和寄存器映射原理
## 1.1 什么是寄存器
### 1.1.1 基本含义
寄存器是CPU内部用来存放数据的一些小型存储区域，用来暂时存放参与运算的数据和运算结果。寄存器就是一种常用的时序逻辑电路，但这种时序逻辑电路只包含存储电路。寄存器的存储电路是由锁存器或触发器构成的。寄存器是中央处理器内的组成部分。寄存器是有限存储容量的高速存储部件，它们可用来暂存指令、数据和位址。

### 1.1.2 基本概念
寄存器最起码具备以下4种功能。
①清除数码：将寄存器里的原有数码清除。
②接收数码：在接收脉冲作用下，将外输入数码存入寄存器中。
③存储数码：在没有新的写入脉冲来之前，寄存器能保存原有数码不变。
④输出数码：在输出脉冲作用下，才通过电路输出数码。
仅具有以上功能的寄存器称为数码寄存器；有的寄存器还具有移位功能，称为移位寄存器。

## 1.2 地址映射和寄存器映射原理
以STM32为例，操作硬件本质上就是操作寄存器。在存储器片上外设区域，四字节为一个单元，每个单元对应不同的功能。当我们控制这些单元时就可以驱动外设工作，我们可以找到每个单元的起始地址，然后通过C 语言指针的操作方式来访问这些单元。但若每次都是通过这种方式访问地址，不好记忆且易出错。这时我们可以根据每个单元功能的不同，以功能为名给这个内存单元取一个别名，这个别名实质上就是寄存器名字。**给已分配好地址(通过存储器映射实现)的有特定功能的内存单元取别名的过程就叫寄存器映射。**

## 1.3 STM32系统架构
STM32 芯片是已经封装好的成品，主要由内核和片上外设组成。若与电脑类比，内核与外设就如同电脑上的 CPU 与主板、内存、显卡、硬盘的关系

 1. 四个驱动单元(CUP)
Cortex™-M3内核DCode总线
Cortex™-M3内核系统总线System
通用DMA1
通用DMA2
 2. 四个被动单元(外设)
内部SRAM
内部闪存存储器FLASH
FSMC
AHB到APB的桥，它连接所有的APB外设
 3. 驱动单元
	* ICode 总线
ICode 中的 I 表示 Instruction，即指令。内核通过ICode 总线读取内部FLASH代码指令来执行程序.。

	* DCode 总线
DCode 中的 D 表示 Data，即数据，那说明这条总线是用来取数的。因为数据可以被 Dcode 总线和 DMA 总线访问（向flash，SRAM，或外设数据寄存器里面取数据），所以为了避免访问冲突，在取数的时候需要经过一个总线矩阵来仲裁，决定哪个总线在取数，取到的数据可以暂存在Cortex™-M3内核里面的寄存器在进行处理。

	* 系统总线System
系统总线主要是访问外设的寄存器，我们通常说的寄存器编程，即读写寄存器都是通过这根系统总线来完成的。

	* DMA 总线
DMA 总线与DCode总线一样主要是用来传输数据，但Dcode总线传输数据要占用内核（cpu）的资源，而DMA总线相当于独立于内核cpu但帮助内核cpu传输数据而不用占用内核（cpu）的资源，就是在DMA传输数据的同时内核cpu可以干别的事情比如点亮一个LED灯

	* 总线矩阵
总线矩阵协调内核系统总线和DMA主控总线之间的访问仲裁，仲裁利用轮换算法。因为数据可以被 Dcode 总线和 DMA 总线访问，数据可以是在某个外设的数据寄存器，可以在SRAM，可以在内部的 FLASH。所以为了避免访问冲突，在取数的时候需要经过一个总线矩阵来仲裁，决定哪个总线在取数

4. 被动单元
	* 内部FLASH
简单介绍在flash存储内容：我们写好的程序编译之后都是一条条指令(二进制代码)，存放在 FLASH 中，我们常量或常变量C 语言中的 const 关键字修饰也存放在FLASH

	* 内部SRAM
就是我们常说的电脑内存条，程序函数内部的局部变量和全局变量，堆（malloc分配）栈(局部变量）等的开销都是基于内部的SRAM。内核通过 DCode 总线来访问它

	* FSMC
FSMC 的英文全称是 Flexible static memory controller，叫灵活的静的存储器控制器，是 STM32F10xx 中一个很有特色的外设通过FSMC我们可以扩展内存，如外部的SRAM，NANDFLASH 和 NORFLASH。但有一点我们要注意的是，FSMC 只能扩展静态的内存，即名称里面的 S：static，不能是动态的内存，比如 SDRAM 就不能扩展。

	* AHB 到 APB 的桥
两个AHB/APB桥在AHB和2个APB总线间提供同步连接。APB1操作速度限于36MHz，APB2操作于全速(最高72MHz)，上面挂载着 STM32 各种各样的特色外设。我们经常说的 GPIO、串口、I2C、SPI 这些外设就挂载在这两条总线上，这个是我们学习 STM32 的重点，就是要学会编程这些外设去驱动外部的各种设备。

## 1.4 STM32的存储空间
stm32芯片内部的总线为32根，内存被划分为一个个的内存单元，每个内存单元的大小是一个字节，为了能有效的访问到内存的每个单元就给内存单元进行编号，编号就被称为该内存单元的地址

![在这里插入图片描述](https://img-blog.csdnimg.cn/cc0db04f1bdd453292efe0a12d7b04aa.png)
